- [VMの設定に関する制約](#vmの設定に関する制約)
  - [ダッシュボード](#ダッシュボード)
  - [OVFファイル](#ovfファイル)
    - [OVFからカスタマイズ可能な項目](#ovfからカスタマイズ可能な項目)
    - [OVFファイルで設定しても反映できない項目](#ovfファイルで設定しても反映できない項目)
      - [TPMについて](#tpmについて)
        - [TPMをOVFに追加する方法](#tpmをovfに追加する方法)
      - [ネットワークの違いによる設定について](#ネットワークの違いによる設定について)

# VMの設定に関する制約
VMのデプロイをする際に、VM作成時の制約が存在する。
VM作成時の制約は、ダッシュボードの操作、OVFの編集で異なる。
ダッシュボード上の操作について記し、その後にOVFの制約について記す。

## ダッシュボード
ダッシュボードからデプロイする際に選択するハードウェアである。以下のように選択される。

1. 仮想マシン -> デプロイ -> 仮想マシンテンプレートを選択してから、デプロイ -> ハードウェアのカスタマイズ
   1. 仮想マシン名
   2. CPUパック or GPUパック
   3. パック数
   4. 仮想ディスクの容量( 20 GiB <= )
   5. ストレージネットワークの選択
   6. サービスネットワークの数(複数必要な場合のみ、既定だと1)
   7. デプロイ後に起動するかどうか(VMテンプレートのみ)
   8. 起動保証仮想マシンを有効化にするかどうか
   9. 初期ユーザの公開鍵(VMテンプレートのみ)
2.  ゲストOSの選択 (ISO Imageからデプロイする時のみ)
   1.  ゲストOSファミリ: Windows, Linux, その他
   2.  ゲストOSバージョン

上記のうち、mdx1のダッシュボード上で設定して、事後に変更不可能なのは、1-5である。
1-4の仮想ディスクの容量について、増量は可能で、縮退は不可能である。
1-5について、1st接続の仮想ディスクのみで、仮想ディスクの追加は、デプロイ後の構成変更空のみ可能である。
それ以外の設定を変更させようとする場合は、以下のようにOVFのエクスポート/インポートの操作が必要になる。

1. 仮想マシン -> ACTION -> メンテナンス -> OVFのエクスポート
2. OVFファイル(.ovf, .vmdk)のダウンロード
3. 仮想マシン -> ACTION -> メンテナンス -> OVFのインポート
4. OVFファイルを選択する
   1. パックタイプの選択
   2. パック数の選択
   3. ストレージネットワークの選択
   4. サービスネットワークの数を選択(既定だと1)

OVFのインポート時に、4-3からストレージネットワークを変更できる。

OVFエクスポート/インポートでVM名について変更は求められないため、同一のVM名が存在する場合は、インポートを行う前に変更しておく必要がある。
OVFインポートを行うVM側の名前を変更するためには、OVFファイルの編集が必要になる。
ゲストOSの種類についても、同様である。
仮想マシンのハードウェアを細部にわたりカスタマイズしたい場合は、OVFファイルを自ら作成する必要がある。

mdx1において、OVFを直接編集することでカスタマイズ可能な項目について記す。

## OVFファイル
OVFファイルを直接編集することで、仮想マシンのハードウェアをカスタマイズすることができる。
ダッシュボードのVMデプロイのウィザードから設定できない項目についても、細かいカスタマイズが可能である。
ただし、mdx1の制約により、すべての項目が設定できるわけではない。

### OVFからカスタマイズ可能な項目
以下は、OVFを直接編集することで、ハードウェアカスタマイズできる。

- VM名
- ファームウェア: BIOS or UEFI
- セキュアブートの有効化: UEFIブートの時のみ
- 仮想ディスクのサイズ:  64Kib <=
- CD/DVDのコントローラ IDE or SATA
- ストレージコントローラ: LSI Logic, LSI Logic SAS, PVSCSI
- ゲストOSの種類

ファームウェアは、mdxの既定だとUEFIだが、セキュアブートは無効化されている。

セキュリティブートを有効化するために、OVFを編集するしかない。

仮想ディスクのサイズについて、OVFインポートであれば20GiB以下のサイズを指定することが可能である。
VMwareにおける最小サイズである64KiBも可能である。

実際にインポートされるvmdkで定義されたサイズ以上であれば、その数字が設定される。
例えば、2GiBで定義されたvmdkがあった際に、インポート時のOVFで10GiBに拡大させたサイズを記載すると、インポート後のサイズに反映される。
インポート後に、構成変更から拡大操作を実行しなくても良い。

CD/DVDの台数は1台で固定である。この1台は、ダッシュボードからISOイメージをマウントするための仮想デバイスである。
複数台設定した場合、仮想マシン内部では認識されるが、ISOイメージを指定してマウントさせることはできない。

ストレージコントローラについても、既定ではLSI Logicになるが、OVFを直接編集することで、LSI Logic SASやPVSCSIを選択することができる。
mdx1ではスナップショットやライブマイグレーションを使用することができないので、特に理由が無ければPVSCSIを使用したほうが、CPU負担は減少し、パフォーマンス向上が見込める。

ゲストOSの種類について、ESXi7.0U2でサポートされているOSしか選択できない。
Linuxカーネルのバージョンは5.xまでで、Rocky LinuxやAlmaLinuxが存在しない。
では包括的に、その他のOSに該当するOtherを選択できるかというと、セキュアブートが正しく動作しなくなる。
ゲストOSの種類について、なるべく一致させるか、近しいOSを選択しておかなければならない。
サポートされているOSについては、ダッシュボード経由でISO Imageからデプロイする際の選択画面から確認できる。

### OVFファイルで設定しても反映できない項目
以下は、OVFを編集しても、インポート後に上書きあるいは無効化される項目である。

- CPU/GPU数: インポート時に選択するため、設定しても上書きされる
- メモリ: CPU/GPUパック数に応じて、固定比で決定される
- サービスネットワーク数: インポート時に選択するため、上書きされる。既定では1
- ストレージネットワーク: インポート時に設定される。
- 仮想TPM: インポートできなくなる、設定不可

インポート時に設定可能な項目については、最小限の値にしておくか、不要であるなら記載しないこと。

仮想TPMについては、ESXi側に仮想TPMのキープロバイダが設定されていないためである。Windows 11のようなTPM必須のOSを使用することができない。

#### TPMについて
- TPMモジュールは使用できない。
- OVFにItem要素で手動で追加してからインポートしようとしても失敗する。
- キープロバイダが構成されたら、将来的に利用できる可能性はあるが、現状はできない _2025-03-14時点_

##### TPMをOVFに追加する方法
- vSphereでWindows 11をインストールする方法: https://www.vmware.com/docs/windows-11-support-on-vsphere
- vSphere 8.0のVMでTPMを有効化する方法: https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere-sdks-tools/8-0/ovf-tool-user-s-guide/examples-of-ovf-tool-syntax/modifying-an-ovf-package/tpm-as-a-virtual-device-in-ovf.html
- vSphereでTPMのキープロバイダを有効化する方法: https://techdocs.broadcom.com/jp/ja/vmware-cis/vsphere/vsphere/7-0/vsphere-security-7-0/configuring-and-managing-vsphere-native-key-provider/configure-a-vsphere-native-key-provider.html
- OVFを編集して直接TPMデバイスを追加する方法

```xml
<Item ovf:required="false">
  <rasd:AutomaticAllocation>false</rasd:AutomaticAllocation>
  <rasd:ElementName>Virtual TPM</rasd:ElementName>
  <rasd:InstanceID>13</rasd:InstanceID>
  <rasd:ResourceSubType>vmware.vtpm</rasd:ResourceSubType>
  <rasd:ResourceType>1</rasd:ResourceType>
</Item>
```

#### ネットワークの違いによる設定について
ネットワークの違いにより、OVF構成ファイルの設定値が異なる部分が生じるが、これらはOVFインポート時の選択により上書きされる。
HVnestedenabledの値について、差異が生じていても、インポート後には反映されない。

ただし、mdx上でデプロイによって生成されたVMについて、ストレージの種類によってエクスポート時のVMDKファイル全体の大きさには、僅かながらの差異が生じる。
完全に同一のイメージではない点に注意が必要だが、相互変換での動作で問題が出た現象を確認できていない。

以下のような変換は可能であることは確認済み

- デプロイ時にSR-IOV -> エクスポート -> インポート時に仮想NIC
- デプロイ時に仮想NIC -> エクスポート -> インポート時にSR-IOV