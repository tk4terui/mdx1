- [はじめに](#はじめに)
- [mdx1の仕様](#mdx1の仕様)
  - [mdx1以外の構成要件](#mdx1以外の構成要件)
- [OSの制約](#osの制約)
- [VMの設定に関する制約](#vmの設定に関する制約)
  - [ダッシュボード](#ダッシュボード)
  - [OVFファイル](#ovfファイル)
    - [OVFからカスタマイズ可能な項目](#ovfからカスタマイズ可能な項目)
    - [OVFファイルで設定しても反映できない項目](#ovfファイルで設定しても反映できない項目)
- [チェックリスト](#チェックリスト)
- [フローチャート](#フローチャート)

# はじめに
mdx1で採用するOSの勘所のメモ。

仮想マシンを使用するため、オンプレミスの環境よりも柔軟にOSを選択することができるが、制約条件も存在する。

mdx1に備えられているハードウェアや共有ファイルシステム、ドライバの機能をフルサポートされているOSを選ぼうとすると、選択肢は限られる。

一方で、一部の性能や機能について折り合いをつけて、OSで提供されている機能を優先する場合は、選択可能なOSの種類も増える。
また、限られたOSで無理やり欲しい機能を動かしたり、導入するための開発コストを負担することのほうが、ハードウェアの機能を犠牲にすることよりも高くなる可能性もある。
mdx1の制約と、OSの選択肢を把握することで、利用者側で仮想マシンの柔軟性を活かせるようになる。

本稿では、これまでの検証結果を元に、OS選択について記す。

# mdx1の仕様
- CPU: インテル® Xeon® Platinum 8368 プロセッサー
- GPU: NVIDIA A100 Tensor
- ストレージコントローラ: PVSCSI
- ネットワーク: VMXNET3, SR-IOV
  - 仮想NIC: 仮想ネットワークドライバ(VMXNET3)
  - SR-IOV: ConnectX mlx5ドライバ, InfiniBand
- 共有ストレージ: Lustreファイルシステム

## mdx1以外の構成要件
- セキュリティソフトの有無
- 機関で指定のソフトウェアがある等

# OSの制約
ドライバの提供の有無に掛かっている。
CPUはx86_64アーキテクチャなので、ほとんどのOSについて問題はないが、GPUやSR-IOV, Lustreについては専用のドライバの提供がなされているかどうかで、OSの選択肢が狭まる。

特にLustreについては、コミュニティから以下のOSのみの提供となっている。

- Ubuntu
- RHEL(Rocky)
- SLES(openSUSE)

GPUやネットワークドライバについて、NVIDIA公式のドライバーダウンロード以外に、ディストリビューションの公式リポジトリから、ディストリビューション向けにビルドされたドライバが提供されている場合もある。
コンパイルすべきかどうかは、使用する前に検討したほうが良い。
ストレージネットワークを使用しないか、InfiniBandを使用しない場合は、仮想NICを選択する
仮想NICはほとんどのOSのデフォルトで組み込まれているドライバである、VMXNET3が選択される。

注意しないといけないのが、VMで定義されているストレージコントローラである。
OVF経由でコントローラを設定しないといけない。
デフォルトだと、LSI Logicがだが、LSI LOGIC SASやPVSCSIを使用したい場合は、OVFを編集して、インポートする必要がある。

PVSCSIを選択した状態で、Windowsをインストールしようとすると、ウィザードの途中でドライバをインストールしないといけない。
ドライバーはVMware ToolsのISOからインストールする必要がある。
Linuxの場合は、自動選択される。

# VMの設定に関する制約
VMのデプロイをする際に、VM作成時の制約が存在する。
VM作成時の制約は、ダッシュボードの操作、OVFの編集で異なる。
ダッシュボード上の操作について記し、その後にOVFの制約について記す。

## ダッシュボード
ダッシュボードからデプロイする際に選択するハードウェアである。以下のように選択される。

1. 仮想マシン -> デプロイ -> 仮想マシンテンプレートを選択してから、デプロイ -> ハードウェアのカスタマイズ
   1. 仮想マシン名
   2. CPUパック or GPUパック
   3. パック数
   4. 仮想ディスクの容量( 20 GiB <= )
   5. ストレージネットワークの選択
   6. サービスネットワークの数(複数必要な場合のみ、既定だと1)
   7. デプロイ後に起動するかどうか(VMテンプレートのみ)
   8. 起動保証仮想マシンを有効化にするかどうか
   9. 初期ユーザの公開鍵(VMテンプレートのみ)
2.  ゲストOSの選択 (ISO Imageからデプロイする時のみ)
   1.  ゲストOSファミリ: Windows, Linux, その他
   2.  ゲストOSバージョン

上記のうち、mdx1のダッシュボード上で設定して、事後に変更不可能なのは、1-5である。
1-4の仮想ディスクの容量について、増量は可能で、縮退は不可能である。
1-5について、1st接続の仮想ディスクのみで、仮想ディスクの追加は、デプロイ後の構成変更空のみ可能である。
それ以外の設定を変更させようとする場合は、以下のようにOVFのエクスポート/インポートの操作が必要になる。

1. 仮想マシン -> ACTION -> メンテナンス -> OVFのエクスポート
2. OVFファイル(.ovf, .vmdk)のダウンロード
3. 仮想マシン -> ACTION -> メンテナンス -> OVFのインポート
4. OVFファイルを選択する
   1. パックタイプの選択
   2. パック数の選択
   3. ストレージネットワークの選択
   4. サービスネットワークの数を選択(既定だと1)

OVFのインポート時に、4-3からストレージネットワークを変更できる。

OVFエクスポート/インポートでVM名について変更は求められないため、同一のVM名が存在する場合は、インポートを行う前に変更しておく必要がある。
OVFインポートを行うVM側の名前を変更するためには、OVFファイルの編集が必要になる。
ゲストOSの種類についても、同様である。
仮想マシンのハードウェアを細部にわたりカスタマイズしたい場合は、OVFファイルを自ら作成する必要がある。

mdx1において、OVFを直接編集することでカスタマイズ可能な項目について記す。

## OVFファイル
OVFファイルを直接編集することで、仮想マシンのハードウェアをカスタマイズすることができる。
ダッシュボードのVMデプロイのウィザードから設定できない項目についても、細かいカスタマイズが可能である。
ただし、mdx1の制約により、すべての項目が設定できるわけではない。

### OVFからカスタマイズ可能な項目
以下は、OVFを直接編集することで、ハードウェアカスタマイズできる。

- VM名
- ファームウェア: BIOS or UEFI
- セキュアブートの有効化: UEFIブートの時のみ
- 仮想ディスクのサイズ:  64Kib <=
- CD/DVDのコントローラ IDE or SATA
- ストレージコントローラ: LSI Logic, LSI Logic SAS, PVSCSI
- ゲストOSの種類

ファームウェアは、mdxの既定だとUEFIだが、セキュアブートは無効化されている。

セキュリティブートを有効化するために、OVFを編集するしかない。

仮想ディスクのサイズについて、OVFインポートであれば20GiB以下のサイズを指定することが可能である。
VMwareにおける最小サイズである64KiBも可能である。

実際にインポートされるvmdkで定義されたサイズ以上であれば、その数字が設定される。
例えば、2GiBで定義されたvmdkがあった際に、インポート時のOVFで10GiBに拡大させたサイズを記載すると、インポート後のサイズに反映される。
インポート後に、構成変更から拡大操作を実行しなくても良い。

CD/DVDの台数は1台で固定である。この1台は、ダッシュボードからISOイメージをマウントするための仮想デバイスである。
複数台設定した場合、仮想マシン内部では認識されるが、ISOイメージを指定してマウントさせることはできない。

ストレージコントローラについても、既定ではLSI Logicになるが、OVFを直接編集することで、LSI Logic SASやPVSCSIを選択することができる。
mdx1ではスナップショットやライブマイグレーションを使用することができないので、特に理由が無ければPVSCSIを使用したほうが、CPU負担は減少し、パフォーマンス向上が見込める。

ゲストOSの種類について、ESXi7.0U2でサポートされているOSしか選択できない。
Linuxカーネルのバージョンは5.xまでで、Rocky LinuxやAlmaLinuxが存在しない。
では包括的に、その他のOSに該当するOtherを選択できるかというと、セキュアブートが正しく動作しなくなる。
ゲストOSの種類について、なるべく一致させるか、近しいOSを選択しておかなければならない。
サポートされているOSについては、ダッシュボード経由でISO Imageからデプロイする際の選択画面から確認できる。

### OVFファイルで設定しても反映できない項目
以下は、OVFを編集しても、インポート後に上書きあるいは無効化される項目である。

- CPU/GPU数: インポート時に選択するため、設定しても上書きされる
- メモリ: CPU/GPUパック数に応じて、固定比で決定される
- サービスネットワーク数: インポート時に選択するため、上書きされる。既定では1
- ストレージネットワーク: インポート時に設定される。
- 仮想TPM: インポートできなくなる、設定不可

インポート時に設定可能な項目については、最小限の値にしておくか、不要であるなら記載しないこと。

仮想TPMについては、ESXi側に仮想TPMのキープロバイダが設定されていないためである。Windows 11のようなTPM必須のOSを使用することができない。

# チェックリスト

# フローチャート





