- [はじめに](#はじめに)
- [mdx1の仕様](#mdx1の仕様)
  - [mdx1以外の構成要件](#mdx1以外の構成要件)
- [OSの制約](#osの制約)
- [チェックリスト](#チェックリスト)
- [フローチャート](#フローチャート)

# はじめに
mdx1で採用するOSの勘所のメモ。

仮想マシンを使用するため、オンプレミスの環境よりも柔軟にOSを選択することができるが、制約条件も存在する。

mdx1に備えられているハードウェアや共有ファイルシステム、ドライバの機能をフルサポートされているOSを選ぼうとすると、選択肢は限られる。

一方で、一部の性能や機能について折り合いをつけて、OSで提供されている機能を優先する場合は、選択可能なOSの種類も増える。
また、限られたOSで無理やり欲しい機能を動かしたり、導入するための開発コストを負担することのほうが、ハードウェアの機能を犠牲にすることよりも高くなる可能性もある。
mdx1の制約と、OSの選択肢を把握することで、利用者側で仮想マシンの柔軟性を活かせるようになる。

本稿では、これまでの検証結果を元に、OS選択について記す。

# mdx1の仕様
- CPU: インテル® Xeon® Platinum 8368 プロセッサー
- GPU: NVIDIA A100 Tensor
- ストレージコントローラ: PVSCSI
- ネットワーク: VMXNET3, SR-IOV
  - 仮想NIC: 仮想ネットワークドライバ(VMXNET3)
  - SR-IOV: ConnectX mlx5ドライバ, InfiniBand
- 共有ストレージ: Lustreファイルシステム

## mdx1以外の構成要件
- セキュリティソフトの有無
- 機関で指定のソフトウェアがある等

# OSの制約
ドライバの提供の有無に掛かっている。
CPUはx86_64アーキテクチャなので、ほとんどのOSについて問題はないが、GPUやSR-IOV, Lustreについては専用のドライバの提供がなされているかどうかで、OSの選択肢が狭まる。

特にLustreについては、コミュニティから以下のOSのみの提供となっている。

- Ubuntu
- RHEL(Rocky)
- SLES(openSUSE)

GPUやネットワークドライバについて、NVIDIA公式のドライバーダウンロード以外に、ディストリビューションの公式リポジトリから、ディストリビューション向けにビルドされたドライバが提供されている場合もある。
コンパイルすべきかどうかは、使用する前に検討したほうが良い。
ストレージネットワークを使用しないか、InfiniBandを使用しない場合は、仮想NICを選択する
仮想NICはほとんどのOSのデフォルトで組み込まれているドライバである、VMXNET3が選択される。

注意しないといけないのが、VMで定義されているストレージコントローラである。
OVF経由でコントローラを設定しないといけない。
デフォルトだと、LSI Logicがだが、LSI LOGIC SASやPVSCSIを使用したい場合は、OVFを編集して、インポートする必要がある。

PVSCSIを選択した状態で、Windowsをインストールしようとすると、ウィザードの途中でドライバをインストールしないといけない。
ドライバーはVMware ToolsのISOからインストールする必要がある。
Linuxの場合は、自動選択される。

# チェックリスト
OS選定に関わるVMの要素について以下のチェックリストにまとめる。

- [ ] Lustreファイルシステムを使用する
  - [ ] コミュニティドライバを使用する
    - [ ] バイナリを利用する
    - [ ] ソースコードからビルドする
  - [ ] mdx1で提供されているドライバを使用する
- [ ] Infiniband (SR-IOV) を使用する
  - [ ] Linux付属インボックスドライバを使用する
  - [ ] ドライバをビルドしてインストールする
- [ ] ストレージネットワーク使用する
- [ ] ストレージコントローラにPVSCSIを使用する
- [ ] セキュアブートを使用する
- [ ] デスクトップとして使用する
- [ ] 特定のソフトウェアを使用する(セキュリティソフト)

OSの使い勝手や、設定ツールの良し悪しなど、ディストリビューションのエコシステムについては考慮せず、mdx1環境の制約によって、使用可能なOSの候補は狭まれる。

# フローチャート

